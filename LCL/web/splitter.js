var CanvasTools={SelectionTool:1,TextTool:2};function Canvas(){var e=this;this.isDragging=false;this.dragStartPos={x:0,y:0};this.scrollStartPos={x:0,y:0};this.scrollStartScroll={x:0,y:0};this.draggingTextAnnot=null;this.draggingDiv=null;this.draggingMoved=false;this.words=new Array();this.hyperlinks=new Array();this.highlights=new Array();this.textAnnots=new Array();this.pageImg=document.getElementById("page_img");this.pagePanel=document.getElementById("page_panel");this.hyperlinksDiv=document.getElementById("hyperlinks");this.annotsDiv=document.getElementById("annots");this.wordSelectionDiv=document.getElementById("word_selection");this.annotsSelectionDiv=document.getElementById("annots_selection");this.markupDiv=document.getElementById("markup");this.currSelections=null;this.zoom=1;this.selectionOverhang=5;this.boxThreshold=4;this.tool=CanvasTools.SelectionTool;this.defaultTextAnnot=new TextAnnot(0,0,"","Arial",10,false,false,"rgb(0, 0, 0)",false,false,"rgb(255, 255, 255)");this.wrapperDiv=document.createElement("div");this.wrapperDiv.style.visibility="hidden";this.wrapperDiv.style.height="auto";document.body.appendChild(this.wrapperDiv);this.editBox=new EditBox(EditBoxModes.TextBox,this.markupDiv);this.editBox.Hide();this.grips=new GripSet(4,this.editBox.GetBounds(),this.markupDiv);this.grips.Hide();this.grips.onuserresize=function(f){e.editBox.SetBounds(f)};this.grips.onlimitsize=function(f){var g=false;annotX=e.InvScale(f.x-e.pageImg.offsetLeft);annotY=e.InvScale(f.y-e.pageImg.offsetTop);annotW=e.InvScale(f.w);annotH=e.InvScale(f.h);if(annotX<0){annotX=0;g=true}if(annotY<0){annotY=0;g=true}if(annotW<2){annotW=2;g=true}if(annotH<2){annotH=2;g=true}if(annotW>pageImageWidth){annotW=pageImageWidth;g=true}if(annotH>pageImageHeight){annotH=pageImageHeight;g=true}if(annotX+annotW>=pageImageWidth){annotX=pageImageWidth-annotW;g=true}if(annotY+annotH>=pageImageHeight){annotY=pageImageHeight-annotH;g=true}if(g){f.x=e.Scale(annotX)+e.pageImg.offsetLeft;f.y=e.Scale(annotY)+e.pageImg.offsetTop;f.w=e.Scale(annotW);f.h=e.Scale(annotH)}};this.editBox.onresize=function(){var f=e.editBox.GetBounds();e.grips.ResizeRect(f.x,f.y,f.w,f.h);if(e.textAnnotSelectionDiv){e.UpdateTextAnnotSelectionDiv(f.x,f.y,f.w,f.h);var g=e.textAnnotSelectionDiv.annotDiv.associatedTextAnnot;g.x=e.InvScale(f.x-e.pageImg.offsetLeft);g.y=e.InvScale(f.y-e.pageImg.offsetTop);if(e.editBox.GetMode()==EditBoxModes.TextBox){g.w=e.InvScale(f.w);g.h=e.InvScale(f.h)}}};this.NewDrawingTextBoxDiv();this.textAnnotSelectionDiv=null;var c=function(f){f=f||window.event;var l=GetMouseCoordsRel(f,e.pageImg);if((f.targetTouches&&f.targetTouches.length==2)||f.shiftKey){if(e.isDragging){var g=GetMouseCoords(f);e.pagePanel.scrollLeft=e.scrollStartPos.x-g.x+e.scrollStartScroll.x;e.pagePanel.scrollTop=e.scrollStartPos.y-g.y+e.scrollStartScroll.y}}else{if(e.draggingTextAnnot!=null&&e.draggingDiv!=null){e.draggingTextAnnot.x=e.dragStartX+e.InvScale(l.x-e.dragStartPos.x);e.draggingTextAnnot.y=e.dragStartY+e.InvScale(l.y-e.dragStartPos.y);if(e.draggingTextAnnot.x!=e.dragStartX||e.draggingTextAnnot.y!=e.dragStartY){e.draggingMoved=true}var j,k;if(e.editBox.IsVisible()){var n=e.editBox.GetBounds();j=e.InvScale(n.w);k=e.InvScale(n.h)}else{j=e.InvScale(e.draggingDiv.clientWidth);k=e.InvScale(e.draggingDiv.clientHeight)}if(e.draggingTextAnnot.x<0){e.draggingTextAnnot.x=0}if(e.draggingTextAnnot.y<0){e.draggingTextAnnot.y=0}if(e.draggingTextAnnot.x+j>=pageImageWidth){e.draggingTextAnnot.x=pageImageWidth-j}if(e.draggingTextAnnot.y+k>=pageImageHeight){e.draggingTextAnnot.y=pageImageHeight-k}var o=e.Scale(e.draggingTextAnnot.x)+e.pageImg.offsetLeft;var m=e.Scale(e.draggingTextAnnot.y)+e.pageImg.offsetTop;e.draggingDiv.style.left=o+"px";e.draggingDiv.style.top=m+"px";if(e.editBox.IsVisible()){e.editBox.SetPosition(o,m)}if(e.annotsSelectionDiv.childNodes.length>0){e.annotsSelectionDiv.childNodes[0].style.left=o-e.selectionOverhang+"px";e.annotsSelectionDiv.childNodes[0].style.top=m-e.selectionOverhang+"px"}}else{if(e.tool==CanvasTools.TextTool){if(e.isDragging){var o=Math.min(l.x,e.dragStartPos.x);var m=Math.min(l.y,e.dragStartPos.y);var p=Math.abs(l.x-e.dragStartPos.x);var i=Math.abs(l.y-e.dragStartPos.y);o+=e.pageImg.offsetLeft;m+=e.pageImg.offsetTop;e.drawingTextBoxDiv.style.left=o+"px";e.drawingTextBoxDiv.style.top=m+"px";e.drawingTextBoxDiv.style.width=p+"px";e.drawingTextBoxDiv.style.height=i+"px";if(Math.abs(l.x-e.dragStartPos.x)>=e.boxThreshold&&Math.abs(l.y-e.dragStartPos.y)>=e.boxThreshold){e.drawingTextBoxDiv.style.visibility="visible"}else{e.drawingTextBoxDiv.style.visibility="hidden"}}}else{if(e.isDragging){e.SelectText(f,e.dragStartPos.x,e.dragStartPos.y,l.x,l.y)}}}}};var b=function(f){f=f||window.event;var g=GetMouseCoordsRel(f,e.pageImg);if(e.tool==CanvasTools.TextTool){if(e.IsTextAnnotSelected()){e.Deselect()}else{e.dragStartPos=g;e.isDragging=true}}else{if(!e.SelectOverlay(f,g)){e.dragStartPos=g;e.isDragging=true;e.scrollStartPos=GetMouseCoords(f);e.scrollStartScroll={x:e.pagePanel.scrollLeft,y:e.pagePanel.scrollTop};e.Deselect()}}f.preventDefault?f.preventDefault():f.returnValue=false;return false};var a=function(f){f=f||window.event;if(e.tool==CanvasTools.TextTool){if(e.isDragging){e.isDragging=false;e.drawingTextBoxDiv.style.visibility="hidden";var k=GetMouseCoordsRel(f,e.pageImg);var m=Math.min(k.x,e.dragStartPos.x);var l=Math.min(k.y,e.dragStartPos.y);e.Deselect();var g=0;var o=0;if(Math.abs(k.x-e.dragStartPos.x)>=e.boxThreshold&&Math.abs(k.y-e.dragStartPos.y)>=e.boxThreshold){var n=Math.abs(k.x-e.dragStartPos.x);var i=Math.abs(k.y-e.dragStartPos.y);g=e.InvScale(n);o=e.InvScale(i)}else{}var j=new TextAnnot(e.InvScale(m),e.InvScale(l),"",e.defaultTextAnnot.font,e.defaultTextAnnot.size,e.defaultTextAnnot.bold,e.defaultTextAnnot.italic,e.defaultTextAnnot.color,e.defaultTextAnnot.border,e.defaultTextAnnot.background,e.defaultTextAnnot.backgroundColor);j.w=g;j.h=o;j.isSelected=true;e.textAnnots.push(j);e.NewTextAnnotDiv(j).StartEditing();e.onSelectionChange(null)}}e.isDragging=false;e.draggingTextAnnot=null;e.draggingDiv=null};var d=function(f){f=f||window.event;var g=GetMouseCoordsRel(f,e.pageImg);e.SelectWord(f,g.x,g.y)};if(document.addEventListener){document.addEventListener("mousemove",c,false);this.pageImg.addEventListener("mousedown",b,false);this.wordSelectionDiv.addEventListener("mousedown",b,false);document.addEventListener("mouseup",a,false);this.pageImg.addEventListener("dblclick",d,false);document.addEventListener("touchmove",c,false);this.pageImg.addEventListener("touchstart",b,false);document.addEventListener("touchend",a,false)}else{if(document.attachEvent){document.attachEvent("onmousemove",c);this.pageImg.attachEvent("onmousedown",b);this.wordSelectionDiv.attachEvent("onmousedown",b);document.attachEvent("onmouseup",a);this.pageImg.attachEvent("ondblclick",d)}}this.PopulateHyperlinks()}Canvas.prototype.SetTool=function(a){this.tool=a};Canvas.prototype.LoadData=function(d,a,b,c){this.Deselect();this.words=d;this.hyperlinks=a;this.highlights=c;this.textAnnots=b;this.Redraw()};Canvas.prototype.LoadImage=function(a,c,b){var d=this;this.pageImg.style.width=a+"px";this.pageImg.style.height=c+"px";this.pageImg.src=b};Canvas.prototype.NewBlockDiv=function(a){var b=document.createElement("div");b.style.position="absolute";b.style.lineHeight="0px";b.style.left=(this.Scale(a.x)+this.pageImg.offsetLeft)+"px";b.style.top=(this.Scale(a.y)+this.pageImg.offsetTop)+"px";b.style.width=this.Scale(a.w)+"px";b.style.height=this.Scale(a.h)+"px";b.style.backgroundColor="#0020ff";b.style.opacity=0.3;b.style.filter="alpha(opacity=30)";b.appendChild(document.createComment(""));b.style.visibility="hidden";this.wordSelectionDiv.appendChild(b);b.style.visibility=""};Canvas.prototype.UpdateBlockDiv=function(b,a){b.style.left=(this.Scale(a.x)+this.pageImg.offsetLeft)+"px";b.style.top=(this.Scale(a.y)+this.pageImg.offsetTop)+"px";b.style.width=this.Scale(a.w)+"px";b.style.height=this.Scale(a.h)+"px";b.style.visibility="visible"};Canvas.prototype.EndEditing=function(){if(this.editBox.IsVisible()){var c=this.editBox.GetText();for(var a=0;a<this.textAnnots.length;++a){if(this.textAnnots[a].isSelected){if(c.length>0){this.textAnnots[a].text=c;if(this.editBox.GetMode()==EditBoxModes.TextBox){var b=this.editBox.GetBounds();this.textAnnots[a].x=this.InvScale(b.x-this.pageImg.offsetLeft);this.textAnnots[a].y=this.InvScale(b.y-this.pageImg.offsetTop);this.textAnnots[a].w=this.InvScale(b.w);this.textAnnots[a].h=this.InvScale(b.h)}this.UpdateTextAnnotDiv(this.textAnnotSelectionDiv.annotDiv,this.textAnnots[a])}else{this.textAnnots.splice(a,1);this.annotsSelectionDiv.removeChild(this.textAnnotSelectionDiv);--a}}}this.editBox.Hide();this.grips.Hide()}};Canvas.prototype.RemoveTextSelection=function(){this.textAnnotSelectionDiv=null;RemoveAllChildren(this.wordSelectionDiv);RemoveAllChildren(this.annotsSelectionDiv);this.currSelections=new Array();this.PlaceOnClipboard("")};Canvas.prototype.PlaceOnClipboard=function(a){var b=document.getElementById("clipboard");if(a==null||a==""){b.value="";b.blur()}else{b.value=a;b.select();b.focus()}};Canvas.prototype.Deselect=function(){var b=false;this.EndEditing();this.RemoveTextSelection();for(var a=0;a<this.textAnnots.length;){this.textAnnots[a].isSelected=false;if(this.textAnnots[a].text.length==0){this.textAnnots.splice(a,1);b=true}else{++a}}for(var a=0;a<this.hyperlinks.length;++a){this.hyperlinks[a].isSelected=false}for(var a=0;a<this.highlights.length;++a){if(this.highlights[a].isSelected){this.highlights[a].isSelected=false;b=true}}if(b){this.PopulateAnnots()}this.onSelectionChange(null)};Canvas.prototype.DeleteSelectedTextAnnot=function(){var b=false;for(var a=0;a<this.textAnnots.length;){if(this.textAnnots[a].isSelected){this.textAnnots.splice(a,1);b=true}else{++a}}if(b){this.EndEditing();this.RemoveTextSelection();this.PopulateAnnots();this.onSelectionChange(null)}};Canvas.prototype.SelectText=function(b,m,l,f,e){if(m==f&&l==e){this.Deselect();return}m=this.InvScale(m);l=this.InvScale(l);f=this.InvScale(f);e=this.InvScale(e);var c=new Array();var n=null;var k="";for(var g=0;g<this.words.length;g+=5){var o=this.words[g];var h=this.words[g+1];var j=this.words[g]+this.words[g+2]-1;var d=this.words[g+1]+this.words[g+3]-1;if(Math.min(l,e)<h&&Math.max(l,e)>d||l<h&&e>=h&&f>=o||e<h&&l>=h&&m>=o||l<=d&&e>d&&m<=j||e<=d&&l>d&&f<=j||(l>=h&&l<=d)&&(e>=h&&e<=d)&&(Math.min(m,f)<=j&&Math.max(m,f)>=o)){k+=this.words[g+4];if(n==null){n=new Rect(this.words[g],this.words[g+1],this.words[g+2],this.words[g+3])}else{if(n.y==this.words[g+1]&&n.h==this.words[g+3]){n.w=Math.max(n.w,this.words[g]+this.words[g+2]-n.x)}else{c.push(n);n=new Rect(this.words[g],this.words[g+1],this.words[g+2],this.words[g+3])}}}}if(n){c.push(n)}var a=this.wordSelectionDiv.childNodes.length;for(var g=0;g<Math.max(a,c.length);++g){if(g>=c.length){this.wordSelectionDiv.childNodes[g].style.visibility="hidden"}else{if(g>=a){this.NewBlockDiv(c[g])}else{if(this.currSelections==null||g>=this.currSelections.length||this.currSelections[g].x!=c[g].x||this.currSelections[g].y!=c[g].y||this.currSelections[g].w!=c[g].w||this.currSelections[g].h!=c[g].h){this.UpdateBlockDiv(this.wordSelectionDiv.childNodes[g],c[g])}}}}this.currSelections=c;this.onSelectionChange(b);this.PlaceOnClipboard(k)};Canvas.prototype.SetZoom=function(a){this.zoom=a};Canvas.prototype.Scale=function(a){return Math.round(a*zoom)};Canvas.prototype.InvScale=function(a){return Math.floor(a/zoom)};Canvas.prototype.ScaleFont=function(a){return Scale(a*dpi/72)};Canvas.prototype.ScaleFont100pc=function(a){return a*dpi/72};Canvas.prototype.SelectWord=function(a,g,f){this.Deselect();g=this.InvScale(g);f=this.InvScale(f);for(var c=0;c<this.words.length;c+=5){var j=this.words[c];var d=this.words[c+1];var e=this.words[c]+this.words[c+2]-1;var b=this.words[c+1]+this.words[c+3]-1;if(g>=j&&g<=e&&f>=d&&f<=b){var h=new Rect(this.words[c],this.words[c+1],this.words[c+2],this.words[c+3]);this.PlaceOnClipboard(this.words[c+4]);this.NewBlockDiv(h);this.currSelections=new Array();this.currSelections.push(h);this.onSelectionChange(a);break}}};Canvas.prototype.Redraw=function(){if(this.currSelections&&this.currSelections.length>0){RemoveAllChildren(this.wordSelectionDiv);RemoveAllChildren(this.annotsSelectionDiv);this.textAnnotSelectionDiv=null;for(var a=0;a<this.currSelections.length;++a){this.NewBlockDiv(this.currSelections[a])}}else{this.RemoveTextSelection()}this.PopulateHyperlinks();this.PopulateAnnots();if(this.textAnnotSelectionDiv){var c=this.textAnnotSelectionDiv.annotDiv.associatedTextAnnot;this.editBox.SetStyle(c.font,this.ScaleFont(c.size)+"px",c.bold,c.italic,c.color,c.border?"1px solid black":"1px dotted gray",c.background?c.backgroundColor:null);var b=new Rect(this.Scale(c.x)+this.pageImg.offsetLeft,this.Scale(c.y)+this.pageImg.offsetTop,this.Scale(c.w),this.Scale(c.h));this.editBox.SetBounds(b);this.editBox.Focus()}};Canvas.prototype.NewHyperlinkDiv=function(){var a=document.createElement("div");a.style.position="absolute";a.style.lineHeight="0px";a.style.backgroundColor="#bb00ff";a.style.opacity=0.7;a.style.filter="alpha(opacity=70)";a.appendChild(document.createComment(""));return a};Canvas.prototype.NewHyperlinkDivs=function(j,b){var e=this;var g=this.NewHyperlinkDiv();g.style.height="1px";this.hyperlinksDiv.appendChild(g);var c=this.NewHyperlinkDiv();c.style.height="1px";this.hyperlinksDiv.appendChild(c);var m=this.NewHyperlinkDiv();m.style.width="1px";this.hyperlinksDiv.appendChild(m);var f=this.NewHyperlinkDiv();f.style.width="1px";this.hyperlinksDiv.appendChild(f);var k=this.Scale(j.x)+this.pageImg.offsetLeft;var i=this.Scale(j.y)+this.pageImg.offsetTop;var l=this.Scale(j.w);var d=this.Scale(j.h);g.style.left=k+"px";g.style.top=i+"px";g.style.width=l+"px";c.style.left=k+"px";c.style.top=(i+d-1)+"px";c.style.width=l+"px";m.style.left=k+"px";m.style.top=i+"px";m.style.height=d+"px";f.style.left=(k+l-1)+"px";f.style.top=i+"px";f.style.height=d+"px";if(b){var a=document.createElement("div");a.style.position="absolute";a.style.lineHeight="0px";a.style.backgroundColor="#bb00ff";a.style.opacity=0.3;a.style.filter="alpha(opacity=30)";a.style.left=k+"px";a.style.top=i+"px";a.style.width=l+"px";a.style.height=d+"px";a.appendChild(document.createComment(""));a.style.visibility="hidden";this.annotsSelectionDiv.appendChild(a);a.style.visibility="";a.onmousedown=function(h){h=h||window.event;e.onSelectionChange(h);return false};a.ondrag=function(){return false};a.onselectstart=function(){return false}}};Canvas.prototype.PopulateHyperlinks=function(){RemoveAllChildren(this.hyperlinksDiv);for(var a=0;a<this.hyperlinks.length;++a){this.NewHyperlinkDivs(this.hyperlinks[a].rect,this.hyperlinks[a].isSelected)}};Canvas.prototype.SelectOverlay=function(c,f){var e=this.InvScale(f.x);var d=this.InvScale(f.y);for(var a=0;a<this.highlights.length;++a){var b=this.highlights[a].rect;if(e>=b.x&&e<=b.x+b.w-1&&d>=b.y&&d<=b.y+b.h-1){this.Deselect();this.highlights[a].isSelected=true;this.PopulateAnnots();this.onSelectionChange(c);return true}}for(var a=0;a<this.hyperlinks.length;++a){var b=this.hyperlinks[a].rect;if(e>=b.x&&e<=b.x+b.w-1&&d>=b.y&&d<=b.y+b.h-1){this.Deselect();this.hyperlinks[a].isSelected=true;this.PopulateHyperlinks();this.onSelectionChange(c);return true}}return false};Canvas.prototype.MeasureText=function(c){var b=new TextMeasure(this.annotsSelectionDiv);b.SetFont(c.font,this.ScaleFont(c.size)+"px",c.bold,c.italic);b.SetContent(c.text);var a={w:b.GetWidth(),h:b.GetHeight()};this.annotsSelectionDiv.removeChild(b.measureDiv);return a};Canvas.prototype.NewDrawingTextBoxDiv=function(){this.drawingTextBoxDiv=document.createElement("div");this.drawingTextBoxDiv.style.position="absolute";this.drawingTextBoxDiv.style.lineHeight="0px";this.drawingTextBoxDiv.style.border="1px black dotted";this.drawingTextBoxDiv.style.background="#c0f0ff";this.drawingTextBoxDiv.style.opacity=0.4;this.drawingTextBoxDiv.style.filter="alpha(opacity=40)";this.drawingTextBoxDiv.style.visibility="hidden";this.markupDiv.appendChild(this.drawingTextBoxDiv)};Canvas.prototype.NewHighlightAnnotDiv=function(c){var f=document.createElement("div");f.style.position="absolute";f.style.lineHeight="0px";f.style.backgroundColor=c.color;f.style.opacity=0.7;f.style.filter="alpha(opacity=70)";f.appendChild(document.createComment(""));var a=this.Scale(c.rect.x)+this.pageImg.offsetLeft;var e=this.Scale(c.rect.y)+this.pageImg.offsetTop;var b=this.Scale(c.rect.w);var d=this.Scale(c.rect.h);f.style.left=a+"px";f.style.top=e+"px";f.style.width=b+"px";f.style.height=d+"px";if(c.isSelected){f.style.borderStyle="solid";f.style.borderWidth="1px";f.style.borderColor="black"}this_=this;f.associatedHighlightAnnot=c;f.onselectstart=function(){return false};f.onmousedown=function(g){g=g||window.event;if(!this.associatedHighlightAnnot.isSelected){this_.Deselect();this.associatedHighlightAnnot.isSelected=true;this.style.borderStyle="solid";this.style.borderWidth="1px";this.style.borderColor="black";this_.onSelectionChange(null)}return false};f.style.visibility="hidden";this.annotsDiv.appendChild(f);f.style.visibility=""};Canvas.prototype.NewTextAnnotSelectionDiv=function(a,f,c,b){var e=this;var d=document.createElement("div");d.onselectstart=function(){return false};d.style.position="absolute";d.style.lineHeight="0px";d.style.border=this.selectionOverhang+"px solid blue";d.style.opacity=0.3;d.style.filter="alpha(opacity=30)";d.style.left=a-this.selectionOverhang+"px";d.style.top=f-this.selectionOverhang+"px";d.style.width=c.w+"px";d.style.height=c.h+"px";d.appendChild(document.createComment(""));d.annotDiv=b;d.onmousedown=function(g){this.annotDiv.onmousedown(g);return false};d.onmouseup=function(g){this.annotDiv.onmouseup(g);return false};d.onselectstart=function(){return false};d.style.visibility="hidden";this.annotsSelectionDiv.appendChild(d);d.style.visibility="";this.textAnnotSelectionDiv=d};Canvas.prototype.UpdateTextAnnotSelectionDiv=function(a,d,b,c){this.textAnnotSelectionDiv.style.left=a-this.selectionOverhang+"px";this.textAnnotSelectionDiv.style.top=d-this.selectionOverhang+"px";this.textAnnotSelectionDiv.style.width=b+"px";this.textAnnotSelectionDiv.style.height=c+"px"};function AppendTextNodesWithLineBreaks(d,c){var a=c.split("\n");for(var b=0;b<a.length;++b){if(b!=0){d.appendChild(document.createElement("br"))}d.appendChild(document.createTextNode(a[b]))}}Canvas.prototype.NewTextAnnotDiv=function(d){var g=document.createElement("div");g.style.position="absolute";g.style.background="url(#)";g.style.backgroundRepeat="repeat";TextAnnotToStyle(d,g);g.style.fontSize=this.ScaleFont(d.size)+"px";g.style.whiteSpace="pre";if(d.border){g.style.border="1px solid black";g.style.margin="-1px"}else{g.style.border="1px dotted gray";g.style.margin="-1px"}var a=this.Scale(d.x)+this.pageImg.offsetLeft;var f=this.Scale(d.y)+this.pageImg.offsetTop;g.style.left=a+"px";g.style.top=f+"px";var c;var b;if(d.w==0&&d.h==0){c=this.MeasureText(d);b=d.text}else{c={w:this.Scale(d.w),h:this.Scale(d.h)};this.wrapperDiv.style.width=d.w+"px";TextAnnotToStyle(d,this.wrapperDiv);this.wrapperDiv.style.fontSize=this.ScaleFont100pc(d.size)+"px";b=Wrap(this.wrapperDiv,d.text);d.wrappedText=b}g.style.width=c.w+"px";g.style.height=c.h+"px";if(d.color){g.style.color=d.color}g.style.cursor="default";AppendTextNodesWithLineBreaks(g,b);g.onselectstart=function(){return false};var e=this;g.associatedTextAnnot=d;g.isDragging=false;g.onmousedown=function(i){i=i||window.event;if(!this.associatedTextAnnot.isSelected){e.Deselect();this.associatedTextAnnot.isSelected=true;var h=clipPx(this.style.left);var k=clipPx(this.style.top);var j;if(this.associatedTextAnnot.w==0&&this.associatedTextAnnot.h==0){j=e.MeasureText(this.associatedTextAnnot)}else{j={w:e.Scale(this.associatedTextAnnot.w),h:e.Scale(this.associatedTextAnnot.h)}}e.NewTextAnnotSelectionDiv(h,k,j,g);e.onSelectionChange(null)}e.draggingTextAnnot=this.associatedTextAnnot;e.draggingDiv=this;e.dragStartPos=GetMouseCoordsRel(i,e.pageImg);e.dragStartX=this.associatedTextAnnot.x;e.dragStartY=this.associatedTextAnnot.y;e.draggingMoved=false;e.editBox.Disable();return false};g.onmouseup=function(h){h=h||window.event;e.editBox.Enable();if(e.draggingTextAnnot==this.associatedTextAnnot&&!e.draggingMoved){this.StartEditing()}e.isDragging=false;e.draggingTextAnnot=null;e.draggingDiv=null};g.StartEditing=function(){this.style.visibility="hidden";e.editBox.SetStyle(this.associatedTextAnnot.font,e.ScaleFont(this.associatedTextAnnot.size)+"px",this.associatedTextAnnot.bold,this.associatedTextAnnot.italic,this.associatedTextAnnot.color,this.associatedTextAnnot.border?"1px solid black":"1px dotted gray",this.associatedTextAnnot.background?this.associatedTextAnnot.backgroundColor:null);var i=e.Scale(this.associatedTextAnnot.x)+e.pageImg.offsetLeft;var l=e.Scale(this.associatedTextAnnot.y)+e.pageImg.offsetTop;if(this.associatedTextAnnot.w!=0&&this.associatedTextAnnot.h!=0){var j=e.Scale(this.associatedTextAnnot.w);var k=e.Scale(this.associatedTextAnnot.h);e.editRect=new Rect(this.associatedTextAnnot.x,this.associatedTextAnnot.y,this.associatedTextAnnot.w,this.associatedTextAnnot.h);e.editBox.PopUp(EditBoxModes.TextBox,new Rect(i,l,j,k),this.associatedTextAnnot.text);e.grips.Show()}else{e.editRect=new Rect(this.associatedTextAnnot.x,this.associatedTextAnnot.y,0,0);e.editBox.PopUp(EditBoxModes.TypeWriter,new Rect(i,l,1,1),this.associatedTextAnnot.text);e.grips.Hide()}};if(d.isSelected&&this.editBox.IsVisible()){g.style.visibility="hidden"}this.annotsDiv.appendChild(g);if(d.isSelected){this.NewTextAnnotSelectionDiv(a,f,c,g)}return g};Canvas.prototype.UpdateTextAnnotDiv=function(d,c){var b;var a;if(c.w==0&&c.h==0){b=this.MeasureText(c);a=c.text}else{b={w:this.Scale(c.w),h:this.Scale(c.h)};this.wrapperDiv.style.width=c.w+"px";TextAnnotToStyle(c,this.wrapperDiv);this.wrapperDiv.style.fontSize=this.ScaleFont100pc(c.size)+"px";a=Wrap(this.wrapperDiv,c.text);c.wrappedText=a}d.style.width=b.w+"px";d.style.height=b.h+"px";RemoveAllChildren(d);AppendTextNodesWithLineBreaks(d,a);d.style.visibility="visible"};Canvas.prototype.AddTextAnnot=function(a){this.Deselect();a.isSelected=true;this.textAnnots.push(a);this.NewTextAnnotDiv(a);this.onSelectionChange(null)};Canvas.prototype.PopulateAnnots=function(){RemoveAllChildren(this.annotsDiv);for(var a=0;a<this.textAnnots.length;++a){this.NewTextAnnotDiv(this.textAnnots[a])}for(var a=0;a<this.highlights.length;++a){this.NewHighlightAnnotDiv(this.highlights[a])}};Canvas.prototype.UpdateSelectedTextAnnot=function(){this.Redraw()};Canvas.prototype.UpdateSelectedHighlightAnnot=function(){this.RemoveTextSelection();this.PopulateAnnots()};Canvas.prototype.IsTextAnnotSelected=function(){for(var a=0;a<canvas.textAnnots.length;++a){if(canvas.textAnnots[a].isSelected){return true}}return false};var LinkTypes={URL:1,Page:2,PagePos:3};function UnknownLink(a){this.rect=a;this.linkType=LinkTypes.Page;this.isSelected=false}function Hyperlink(b,a){this.rect=b;this.linkType=LinkTypes.URL;this.url=a;this.isSelected=false}function PageLink(b,a){this.rect=b;this.linkType=LinkTypes.Page;this.pageNo=a;this.isSelected=false}function PageLinkPos(b,a,c){this.rect=b;this.linkType=LinkTypes.PagePos;this.pageNo=a;this.pos=c;this.isSelected=false}function TextAnnot(h,g,j,b,k,f,e,d,c,a,i){this.x=h;this.y=g;this.w=0;this.h=0;this.text=j;this.font=b;this.size=k;this.bold=f;this.italic=e;this.color=d;this.border=c;this.background=a;this.backgroundColor=i;this.isSelected=false;this.wrappedText=""}function TextAnnotToStyle(a,b){b.style.fontFamily=a.font;b.style.fontWeight=a.bold?"bold":"normal";b.style.fontStyle=a.italic?"italic":"normal";b.style.backgroundColor=a.background?a.backgroundColor:""}function HighlightAnnot(b,a){this.rect=b;this.color=a;this.isSelected=false}function WrapLine(f,d){if(!d||d.length==0){return""}var e=d.split(" ");var a=e[0];RemoveAllChildren(f);f.appendChild(document.createTextNode(a));var c=f.clientHeight;for(var b=1;b<e.length;++b){f.childNodes[0].nodeValue+=" "+e[b];if(f.clientHeight!=c){a+="\n"+e[b];f.childNodes[0].nodeValue=e[b];c=f.clientHeight}else{a+=" "+e[b]}}return a}function Wrap(e,d){if(!d||d.length==0){return""}var c=d.replace(/\r/g,"");var a=c.split("\n");for(var b=0;b<a.length;++b){a[b]=WrapLine(e,a[b])}return a.join("\n")};